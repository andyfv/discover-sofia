<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Sofia</title>
    <link rel="stylesheet" type="text/css" href="/assets/normalize.css">
    <link rel="stylesheet" type="text/css" href="/assets/style.css">
    <script src="/src/HereMapsAPI.js" type="module"></script>
    <script src="/elm.js" type="text/javascript"></script>
</head>
<body>
	<div id="app"></div>

    <script type="module">
        import * as HereMapsAPI from '/src/HereMapsAPI.js'

        var app = Elm.Main.init({
            node: document.getElementById("app")
        });

        // Load the libraries -> Initialize the map -> Notify the Elm runtime
        app.ports.mapLoad.subscribe(() =>  {
            HereMapsAPI.loadMapLibs()
            .then(() => HereMapsAPI.createMapHTML())
            .then(() => HereMapsAPI.initMap())
            .then(() => app.ports.mapLoaded.send(null))
            .catch((error) => {
                console.log(error);
                app.ports.mapLoadingFailed.send(error)
            });
        });


        // Send @showLandmarkSummary as a callback function
        app.ports.addMarker.subscribe((landmark) => {
            HereMapsAPI.addMarker(landmark, app.ports.showLandmarkSummary.send)
        })


        app.ports.mapSearch.subscribe((query) => {
            HereMapsAPI.search(
                query, 
                app.ports.mapSearchResponse.send,
                app.ports.mapSearchFailed.send
                );
        })


        // Get location if available on the device. Otherwise return error.
        app.ports.geoserviceLocationGet.subscribe(() => {
            HereMapsAPI.getGeolocation(
                app.ports.geoserviceLocationReceive.send,
                app.ports.geoserviceLocationError.send
            );
        })

              }, function() {
                handleLocationError(true, infoWindow, map.getCenter());
              });
            } else {
              // Browser doesn't support Geolocation
              handleLocationError(false, infoWindow, map.getCenter());

            }
        }

    </script>
</body>
</html>